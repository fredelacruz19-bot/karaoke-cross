rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------
    // Colección: users
    // --------------------------
    // NO permitir actualizaciones directas desde frontend
    // Todas las operaciones van a través de Cloud Functions
    match /users/{userId} {
      
      // Leer solo tus datos o si eres AdminUser
      allow read: if request.auth != null &&
        (request.auth.uid == userId ||
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "AdminUser");

      // NO permitir create, update, delete desde frontend
      // Usar Cloud Functions en su lugar
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    // --------------------------
    // Colección: sessions
    // --------------------------
    // Solo lectura desde frontend
    // Modificaciones a través de Cloud Functions
    match /sessions/{sessionId} {

      // Leer sesiones propias o todas si eres AdminUser
      allow read: if request.auth != null &&
        (request.auth.uid == resource.data.owner ||
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "AdminUser");

      // NO permitir modificaciones directas
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    // --------------------------
    // Colección: cache
    // --------------------------
    // Solo lectura para usuarios autenticados
    // Escritura solo a través de backend
    match /cache/{documentId} {
      allow read: if request.auth != null;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

  }
}
